/*
@author Ronan Delacroix
*/

/*predict_data = {
    "filesize": 470478,
    "processing_times": {
        "predict": 4.486125946044922,
        "resize": 0,
        "total": 4.486125946044922
    },
    "image_size": "635x718",
    "format": "PNG",
    "filename": "2017-09-14_18_10_16-Alejandro_Acosta_on_Twitter___Happy_26th_birthday_Linux_Heres_your_fucking_c.png",
    "content_type": "image/png",
    "derivatives": [
        {
            "filesize": 62397,
            "resized": "2048x2048",
            "image_size": "635x718",
            "format": "JPEG",
            "filename": "2017-09-14_18_10_16-Alejandro_Acosta_on_Twitter___Happy_26th_birthday_Linux_Heres_your_fucking_c.2048_2048.jpg",
            "prediction": {
                "eggnog": 8.507987976074219,
                "Petri dish": 5.467229843139648,
                "measuring cup": 5.22434663772583,
                "corn": 4.401571750640869,
                "face powder": 4.109177112579346
            },
            "processing_times": {
                "predict": 1.2283878326416016,
                "resize": 0.1191408634185791,
                "total": 1.3475291728973389
            }
        },
        {
            "filesize": 473952,
            "resized": "2048x2048",
            "image_size": "635x718",
            "format": "PNG",
            "filename": "2017-09-14_18_10_16-Alejandro_Acosta_on_Twitter___Happy_26th_birthday_Linux_Heres_your_fucking_c.2048_2048.png",
            "prediction": {
                "eggnog": 8.656595230102539,
                "measuring cup": 5.8802618980407715,
                "Petri dish": 5.425858974456787,
                "corn": 4.823561668395996,
                "menu": 4.695251941680908
            },
            "processing_times": {
                "predict": 1.2315030097961426,
                "resize": 0.2690548896789551,
                "total": 1.500558614730835
            }
        },
        {
            "filesize": 62397,
            "resized": "1024x1024",
            "image_size": "635x718",
            "format": "JPEG",
            "filename": "2017-09-14_18_10_16-Alejandro_Acosta_on_Twitter___Happy_26th_birthday_Linux_Heres_your_fucking_c.1024_1024.jpg",
            "prediction": {
                "eggnog": 8.507987976074219,
                "Petri dish": 5.467229843139648,
                "measuring cup": 5.22434663772583,
                "corn": 4.401571750640869,
                "face powder": 4.109177112579346
            },
            "processing_times": {
                "predict": 0.804823637008667,
                "resize": 0.032579898834228516,
                "total": 0.8374037742614746
            }
        },
        {
            "filesize": 473952,
            "resized": "1024x1024",
            "image_size": "635x718",
            "format": "PNG",
            "filename": "2017-09-14_18_10_16-Alejandro_Acosta_on_Twitter___Happy_26th_birthday_Linux_Heres_your_fucking_c.1024_1024.png",
            "prediction": {
                "eggnog": 8.656595230102539,
                "measuring cup": 5.8802618980407715,
                "Petri dish": 5.425858974456787,
                "corn": 4.823561668395996,
                "menu": 4.695251941680908
            },
            "processing_times": {
                "predict": 2.246540069580078,
                "resize": 0.20526337623596191,
                "total": 2.45180344581604
            }
        },
        {
            "filesize": 36929,
            "resized": "512x512",
            "image_size": "453x512",
            "format": "JPEG",
            "filename": "2017-09-14_18_10_16-Alejandro_Acosta_on_Twitter___Happy_26th_birthday_Linux_Heres_your_fucking_c.512_512.jpg",
            "prediction": {
                "eggnog": 8.277688980102539,
                "Petri dish": 6.106291770935059,
                "measuring cup": 5.852258205413818,
                "corn": 4.3940839767456055,
                "face powder": 4.277929782867432
            },
            "processing_times": {
                "predict": 2.4121766090393066,
                "resize": 0.02669501304626465,
                "total": 2.4388725757598877
            }
        },
        {
            "filesize": 273926,
            "resized": "512x512",
            "image_size": "453x512",
            "format": "PNG",
            "filename": "2017-09-14_18_10_16-Alejandro_Acosta_on_Twitter___Happy_26th_birthday_Linux_Heres_your_fucking_c.512_512.png",
            "prediction": {
                "eggnog": 8.480291366577148,
                "measuring cup": 6.158751964569092,
                "Petri dish": 5.961428165435791,
                "corn": 4.83619499206543,
                "menu": 4.76418399810791
            },
            "processing_times": {
                "predict": 0.6983315944671631,
                "resize": 0.08481717109680176,
                "total": 0.783149242401123
            }
        },
        {
            "filesize": 11887,
            "resized": "256x256",
            "image_size": "226x256",
            "format": "JPEG",
            "filename": "2017-09-14_18_10_16-Alejandro_Acosta_on_Twitter___Happy_26th_birthday_Linux_Heres_your_fucking_c.256_256.jpg",
            "prediction": {
                "eggnog": 7.968342304229736,
                "Petri dish": 4.83920955657959,
                "web site, website, internet site, site": 4.616945743560791,
                "face powder": 3.832918643951416,
                "coho, cohoe, coho salmon, blue jack, silver salmon, Oncorhynchus kisutch": 3.6000332832336426
            },
            "processing_times": {
                "predict": 1.3410263061523438,
                "resize": 0.01416325569152832,
                "total": 1.3551890850067139
            }
        },
        {
            "filesize": 78645,
            "resized": "256x256",
            "image_size": "226x256",
            "format": "PNG",
            "filename": "2017-09-14_18_10_16-Alejandro_Acosta_on_Twitter___Happy_26th_birthday_Linux_Heres_your_fucking_c.256_256.png",
            "prediction": {
                "eggnog": 7.953316688537598,
                "measuring cup": 5.1868577003479,
                "Petri dish": 5.092655181884766,
                "web site, website, internet site, site": 5.0042033195495605,
                "menu": 4.923993110656738
            },
            "processing_times": {
                "predict": 0.691295862197876,
                "resize": 0.04048657417297363,
                "total": 0.7317826747894287
            }
        },
        {
            "filesize": 4023,
            "resized": "128x128",
            "image_size": "113x128",
            "format": "JPEG",
            "filename": "2017-09-14_18_10_16-Alejandro_Acosta_on_Twitter___Happy_26th_birthday_Linux_Heres_your_fucking_c.128_128.jpg",
            "prediction": {
                "face powder": 7.894164085388184,
                "eggnog": 7.468074321746826,
                "Petri dish": 5.849847316741943,
                "waffle iron": 5.279712677001953,
                "frying pan, frypan, skillet": 5.023806095123291
            },
            "processing_times": {
                "predict": 0.9213888645172119,
                "resize": 0.012936115264892578,
                "total": 0.9343249797821045
            }
        },
        {
            "filesize": 22502,
            "resized": "128x128",
            "image_size": "113x128",
            "format": "PNG",
            "filename": "2017-09-14_18_10_16-Alejandro_Acosta_on_Twitter___Happy_26th_birthday_Linux_Heres_your_fucking_c.128_128.png",
            "prediction": {
                "eggnog": 8.333078384399414,
                "face powder": 6.643762588500977,
                "Petri dish": 5.5188398361206055,
                "web site, website, internet site, site": 5.40402364730835,
                "waffle iron": 4.487937927246094
            },
            "processing_times": {
                "predict": 1.0992858409881592,
                "resize": 0.016925573348999023,
                "total": 1.1162116527557373
            }
        },
        {
            "filesize": 1594,
            "resized": "64x64",
            "image_size": "56x64",
            "format": "JPEG",
            "filename": "2017-09-14_18_10_16-Alejandro_Acosta_on_Twitter___Happy_26th_birthday_Linux_Heres_your_fucking_c.64_64.jpg",
            "prediction": {
                "hourglass": 7.014172554016113,
                "face powder": 6.362677097320557,
                "frying pan, frypan, skillet": 6.063537120819092,
                "nipple": 5.826485633850098,
                "waffle iron": 5.813521862030029
            },
            "processing_times": {
                "predict": 0.7022490501403809,
                "resize": 0.00938725471496582,
                "total": 0.7116360664367676
            }
        },
        {
            "filesize": 6284,
            "resized": "64x64",
            "image_size": "56x64",
            "format": "PNG",
            "filename": "2017-09-14_18_10_16-Alejandro_Acosta_on_Twitter___Happy_26th_birthday_Linux_Heres_your_fucking_c.64_64.png",
            "prediction": {
                "face powder": 7.680998802185059,
                "loupe, jeweler's loupe": 5.7541279792785645,
                "web site, website, internet site, site": 5.670839786529541,
                "waffle iron": 5.420933723449707,
                "can opener, tin opener": 4.940329551696777
            },
            "processing_times": {
                "predict": 1.3462042808532715,
                "resize": 0.011237859725952148,
                "total": 1.3574419021606445
            }
        },
        {
            "filesize": 932,
            "resized": "32x32",
            "image_size": "28x32",
            "format": "JPEG",
            "filename": "2017-09-14_18_10_16-Alejandro_Acosta_on_Twitter___Happy_26th_birthday_Linux_Heres_your_fucking_c.32_32.jpg",
            "prediction": {
                "nipple": 6.76019811630249,
                "sunscreen, sunblock, sun blocker": 6.290107727050781,
                "dishwasher, dish washer, dishwashing machine": 6.132235050201416,
                "book jacket, dust cover, dust jacket, dust wrapper": 5.5789713859558105,
                "lotion": 5.565054893493652
            },
            "processing_times": {
                "predict": 0.8038196563720703,
                "resize": 0.009926795959472656,
                "total": 0.8137454986572266
            }
        },
        {
            "filesize": 1874,
            "resized": "32x32",
            "image_size": "28x32",
            "format": "PNG",
            "filename": "2017-09-14_18_10_16-Alejandro_Acosta_on_Twitter___Happy_26th_birthday_Linux_Heres_your_fucking_c.32_32.png",
            "prediction": {
                "switch, electric switch, electrical switch": 6.326546669006348,
                "face powder": 5.6393938064575195,
                "nipple": 4.996469974517822,
                "web site, website, internet site, site": 4.985199928283691,
                "sunscreen, sunblock, sun blocker": 4.483786582946777
            },
            "processing_times": {
                "predict": 1.235874891281128,
                "resize": 0.010125875473022461,
                "total": 1.2460012435913086
            }
        }
    ],
    "prediction": {
        "eggnog": 8.656595230102539,
        "measuring cup": 5.8802618980407715,
        "Petri dish": 5.425858974456787,
        "corn": 4.823561668395996,
        "menu": 4.695251941680908
    },
    "statistics": {
        "timings_by_size": {
            "2048x2048": {
                "PNG": 1.500558614730835,
                "JPEG": 1.3475291728973389
            },
            "1024x1024": {
                "PNG": 2.45180344581604,
                "JPEG": 0.8374037742614746
            },
            "512x512": {
                "PNG": 0.783149242401123,
                "JPEG": 2.4388725757598877
            },
            "256x256": {
                "PNG": 0.7317826747894287,
                "JPEG": 1.3551890850067139
            },
            "128x128": {
                "PNG": 1.1162116527557373,
                "JPEG": 0.9343249797821045
            },
            "64x64": {
                "PNG": 1.3574419021606445,
                "JPEG": 0.7116360664367676
            },
            "32x32": {
                "PNG": 1.2460012435913086,
                "JPEG": 0.8137454986572266
            }
        },
        "predictions_by_size": {
            "2048x2048": {
                "PNG": 100,
                "JPEG": 75.82854886538351
            },
            "1024x1024": {
                "PNG": 100,
                "JPEG": 75.82854886538351
            },
            "512x512": {
                "PNG": 102.86001681684778,
                "JPEG": 79.75669886553233
            },
            "256x256": {
                "PNG": 75.76289305966213,
                "JPEG": 36.247455710827424
            },
            "128x128": {
                "PNG": 39.59528638499671,
                "JPEG": 38.816911633816844
            },
            "64x64": {
                "PNG": 0,
                "JPEG": 0
            },
            "32x32": {
                "PNG": 0,
                "JPEG": 0
            }
        },
        "all_timings": {
            "2048x2048 JPEG": {
                "predict": 1.2283878326416016,
                "resize": 0.1191408634185791,
                "total": 1.3475291728973389
            },
            "2048x2048 PNG": {
                "predict": 1.2315030097961426,
                "resize": 0.2690548896789551,
                "total": 1.500558614730835
            },
            "1024x1024 JPEG": {
                "predict": 0.804823637008667,
                "resize": 0.032579898834228516,
                "total": 0.8374037742614746
            },
            "1024x1024 PNG": {
                "predict": 2.246540069580078,
                "resize": 0.20526337623596191,
                "total": 2.45180344581604
            },
            "512x512 JPEG": {
                "predict": 2.4121766090393066,
                "resize": 0.02669501304626465,
                "total": 2.4388725757598877
            },
            "512x512 PNG": {
                "predict": 0.6983315944671631,
                "resize": 0.08481717109680176,
                "total": 0.783149242401123
            },
            "256x256 JPEG": {
                "predict": 1.3410263061523438,
                "resize": 0.01416325569152832,
                "total": 1.3551890850067139
            },
            "256x256 PNG": {
                "predict": 0.691295862197876,
                "resize": 0.04048657417297363,
                "total": 0.7317826747894287
            },
            "128x128 JPEG": {
                "predict": 0.9213888645172119,
                "resize": 0.012936115264892578,
                "total": 0.9343249797821045
            },
            "128x128 PNG": {
                "predict": 1.0992858409881592,
                "resize": 0.016925573348999023,
                "total": 1.1162116527557373
            },
            "64x64 JPEG": {
                "predict": 0.7022490501403809,
                "resize": 0.00938725471496582,
                "total": 0.7116360664367676
            },
            "64x64 PNG": {
                "predict": 1.3462042808532715,
                "resize": 0.011237859725952148,
                "total": 1.3574419021606445
            },
            "32x32 JPEG": {
                "predict": 0.8038196563720703,
                "resize": 0.009926795959472656,
                "total": 0.8137454986572266
            },
            "32x32 PNG": {
                "predict": 1.235874891281128,
                "resize": 0.010125875473022461,
                "total": 1.2460012435913086
            }
        },
        "all_predictions": {
            "2048x2048 JPEG": 75.82854886538351,
            "2048x2048 PNG": 100,
            "1024x1024 JPEG": 75.82854886538351,
            "1024x1024 PNG": 100,
            "512x512 JPEG": 79.75669886553233,
            "512x512 PNG": 102.86001681684778,
            "128x128 JPEG": 38.816911633816844,
            "128x128 PNG": 39.59528638499671,
            "256x256 JPEG": 36.247455710827424,
            "256x256 PNG": 75.76289305966213,
            "64x64 JPEG": 0,
            "64x64 PNG": 0,
            "32x32 JPEG": 0,
            "32x32 PNG": 0
        },
        "average_prediction_by_format": {
            "PNG": 83.64363925230131,
            "JPEG": 61.29563278818872
        },
        "average_timing_by_size": {
            "2048x2048": {
                "predict": 1.229945421218872,
                "resize": 0.1940978765487671,
                "total": 1.424043893814087
            },
            "1024x1024": {
                "predict": 1.5256818532943726,
                "resize": 0.11892163753509521,
                "total": 1.6446036100387573
            },
            "512x512": {
                "predict": 1.5552541017532349,
                "resize": 0.0557560920715332,
                "total": 1.6110109090805054
            },
            "256x256": {
                "predict": 1.0161610841751099,
                "resize": 0.027324914932250977,
                "total": 1.0434858798980713
            },
            "128x128": {
                "predict": 1.0103373527526855,
                "resize": 0.0149308443069458,
                "total": 1.025268316268921
            },
            "64x64": {
                "predict": 1.0242266654968262,
                "resize": 0.010312557220458984,
                "total": 1.034538984298706
            },
            "32x32": {
                "predict": 1.0198472738265991,
                "resize": 0.010026335716247559,
                "total": 1.0298733711242676
            }
        },
        "average_timing_by_format": {
            "PNG": {
                "predict": 1.2212907927376884,
                "resize": 0.091130188533238,
                "total": 1.3124212537493025
            },
            "JPEG": {
                "predict": 1.173410279410226,
                "resize": 0.03211845670427595,
                "total": 1.205528736114502
            }
        },
        "timings_by_format": {
            "PNG": {
                "2048x2048": 1.500558614730835,
                "1024x1024": 2.45180344581604,
                "512x512": 0.783149242401123,
                "256x256": 0.7317826747894287,
                "128x128": 1.1162116527557373,
                "64x64": 1.3574419021606445,
                "32x32": 1.2460012435913086
            },
            "JPEG": {
                "2048x2048": 1.3475291728973389,
                "1024x1024": 0.8374037742614746,
                "512x512": 2.4388725757598877,
                "256x256": 1.3551890850067139,
                "128x128": 0.9343249797821045,
                "64x64": 0.7116360664367676,
                "32x32": 0.8137454986572266
            }
        },
        "predictions_by_format": {
            "PNG": {
                "2048x2048": 100,
                "1024x1024": 100,
                "512x512": 102.86001681684778,
                "256x256": 75.76289305966213,
                "128x128": 39.59528638499671,
                "64x64": 0,
                "32x32": 0
            },
            "JPEG": {
                "2048x2048": 75.82854886538351,
                "1024x1024": 75.82854886538351,
                "512x512": 79.75669886553233,
                "256x256": 36.247455710827424,
                "128x128": 38.816911633816844,
                "64x64": 0,
                "32x32": 0
            }
        }
    }
};*/

$(function () {
    'use strict';

    _.templateSettings = {
        interpolate: /\[\[(.+?)\]\]/g
    };

    function graph_predictions(element_id, type, stats, ref_data) {

        var keys = _.keys(stats);
        var values = _.values(stats);

        var avg_accuracy = [];
        _.each(values, function (stat) {
            var stat2 = _.compact(stat);
            var sum = _.reduce(stat2, function(a, b){ return a + b; }, 0);
            if (sum==0) { return 0; }
            avg_accuracy.push(sum / _.size(stat2));
        });

        keys.splice(0, 0, 'Ref ('+ ref_data +')');
        avg_accuracy.splice(0, 0, 100.0);

        var trace1 = {
            x: avg_accuracy,
            y: keys,
            name: 'Prediction accuracy',
            orientation: 'h',
            marker: {
                color: 'rgba(55,128,191,0.6)',
                width: 1
            },
            type: 'bar'
        };

        var data = [trace1];

        var layout = {
            title: 'Prediction accuracy by size',
            barmode: 'stack',
            yaxis: {
                autorange: 'reversed',
                showticklabels: true
            },
            annotations: []
        };

        for ( var i = 0 ; i < avg_accuracy.length ; i++ ) {
            var result = {
                xref: 'x1',
                yref: 'y1',
                x: avg_accuracy[i]+5,
                y: keys[i],
                text: avg_accuracy[i].toFixed(1) + '%',
                font: {
                    family: 'Arial',
                    size: 12,
                    color: 'rgba(55,128,191,0.6)'
                },
                showarrow: false
            };

          layout.annotations.push(result);
        }

        Plotly.newPlot(element_id, data, layout);
    }

    function graph_average_timing(element_id, type, stats, ref_data, ref_processing_times) {

        var keys = _.keys(stats);
        var values = _.values(stats);
        var predict_timings = _.pluck(values, 'predict');
        var resize_timings = _.pluck(values, 'resize');
        var total_timings = _.pluck(values, 'total');

        keys.splice(0, 0, 'Ref ('+ ref_data +')');
        predict_timings.splice(0, 0, ref_processing_times.predict);
        resize_timings.splice(0, 0, ref_processing_times.resize);
        total_timings.splice(0, 0, ref_processing_times.total);

        var trace1 = {
            x: predict_timings,
            y: keys,
            name: 'Prediction duration',
            orientation: 'h',
            marker: {
                color: 'rgba(55,128,191,0.6)',
                width: 1
            },
            type: 'bar'
        };

        var trace2 = {
            x: resize_timings,
            y: keys,
            name: 'Resize duration',
            orientation: 'h',
            type: 'bar',
            marker: {
                color: 'rgba(255,153,51,0.6)',
                width: 1
            }
        };

        var data = [trace1, trace2];

        var layout = {
            title: 'Prediction and Resizing Timings by '+type,
            barmode: 'stack',
            yaxis: {autorange: 'reversed'},
            legend: {
                x: 0.309,
                y: -0.52,
                font: {
                    size: 10
                }
            },
            annotations: []
        };

        for ( var i = 0 ; i < total_timings.length ; i++ ) {
            var result = {
                xref: 'x1',
                yref: 'y1',
                x: total_timings[i] + total_timings[0]/20,
                y: keys[i],
                text: total_timings[i].toFixed(1) + 's',
                font: {
                    family: 'Arial',
                    size: 12,
                    color: 'rgba(55,128,191,0.6)'
                },
                showarrow: false
            };

          layout.annotations.push(result);
        }

        Plotly.newPlot(element_id, data, layout);
    }



    function getReadableFileSizeString(fileSizeInBytes) {
        var i = -1;
        var byteUnits = [' kB', ' MB', ' GB', ' TB', 'PB', 'EB', 'ZB', 'YB'];
        do {
            fileSizeInBytes = fileSizeInBytes / 1024;
            i++;
        } while (fileSizeInBytes > 1024);

        return Math.max(fileSizeInBytes, 0.1).toFixed(1) + byteUnits[i];
    }

    function process_result(files) {
        $("#results").html('');

        $.each(files, function (index, file) {


            graph_average_timing(
                'graph1', 'size',
                file.statistics.average_timing_by_size,
                file.image_size,
                file.processing_times
            );
            graph_predictions(
                'graph2', 'size',
                file.statistics.predictions_by_size,
                file.image_size
            );
            graph_average_timing(
                'graph3', 'format',
                file.statistics.average_timing_by_format,
                file.format,
                file.processing_times
            );
            graph_predictions(
                'graph4', 'format',
                file.statistics.predictions_by_format,
                file.format
            );

            var file_tmpl = _.template($("#file_template").html());
            var resized_file_tmpl = _.template($("#resized_file_template").html());

            file.filesize = getReadableFileSizeString(file.filesize);
            var derivatives_html = $('<div/>');
            _.each(file.derivatives, function(resized_file) {
                resized_file.original_timing = file.processing_times.total;
                resized_file.processing_times.total_percent = resized_file.processing_times.total / resized_file.original_timing * 100.0;
                resized_file.processing_times.predict_percent = resized_file.processing_times.predict / resized_file.processing_times.total * 100.0;
                resized_file.processing_times.resize_percent = resized_file.processing_times.resize / resized_file.processing_times.total * 100.0;
                resized_file.filesize = getReadableFileSizeString(resized_file.filesize)
                derivatives_html.append(resized_file_tmpl(resized_file));
            });
            file.processed_derivatives = derivatives_html.html();
            var processed_html = file_tmpl(file);
            $("#results").append(processed_html);
        });
    }




    // Change this to the location of your server-side upload handler:
    var url = '/upload',
        uploadButton = $('<button/>')
            .addClass('upload-button')
            .prop('disabled', true)
            .text('Processing...')
            .on('click', function () {
                var $this = $(this),
                    data = $this.data();
                $this
                    .off('click')
                    .text('Abort')
                    .on('click', function () {
                        $this.remove();
                        data.abort();
                    });
                data.submit().always(function () {
                    $this.remove();
                });
            });
    $('#fileupload').fileupload({
        url: url,
        dataType: 'json',
        autoUpload: true,
        acceptFileTypes: /(\.|\/)(gif|jpe?g|png|bmp)$/i,
        maxFileSize: 99900000,
        disableImageResize: true,
        previewMaxWidth: 100,
        previewMaxHeight: 100,
        previewCrop: true
    }).on('fileuploadadd', function (e, data) {
        $("#image-upload > span.upload-button").addClass('done');
        data.context = $('<div/>').appendTo('#files');
        $.each(data.files, function (index, file) {
            var node = $('<p/>')
                    .append($('<span/>').text(file.name));
            if (!index) {
                node
                    .append('<br>')
                    .append(uploadButton.clone(true).data(data));
            }
            node.appendTo(data.context);
        });
    }).on('fileuploadprocessalways', function (e, data) {
        var index = data.index,
            file = data.files[index],
            node = $(data.context.children()[index]);
        if (file.preview) {
            node
                .prepend('<br>')
                .prepend(file.preview);
        }
        if (file.error) {
            node
                .append('<br>')
                .append($('<span class="text-danger"/>').text(file.error));
        }
        if (index + 1 === data.files.length) {
            data.context.find('button')
                .text('Upload')
                .prop('disabled', !!data.files.error);
        }
    }).on('fileuploadprogressall', function (e, data) {
        var progress = parseInt(data.loaded / data.total * 100, 10);
        $('#progress .progress-bar').css(
            'width',
            progress + '%'
        );
    }).on('fileuploaddone', function (e, data) {
        $('#results').html('<pre>'+JSON.stringify(data.result, null, '    ')+'</pre>');

        process_result(data.result.files);

        /*$.each(data.result.files, function (index, file) {
            if (file.url) {
                var link = $('<a>')
                    .attr('target', '_blank')
                    .prop('href', file.url);
                $(data.context.children()[index])
                    .wrap(link);
            } else if (file.error) {
                var error = $('<span class="text-danger"/>').text(file.error);
                $(data.context.children()[index])
                    .append('<br>')
                    .append(error);
            }
        });*/
    }).on('fileuploadfail', function (e, data) {
        $.each(data.files, function (index) {
            var error = $('<span class="text-danger"/>').text('File upload failed.');
            $(data.context.children()[index])
                .append('<br>')
                .append(error);
        });
    }).prop('disabled', !$.support.fileInput)
        .parent().addClass($.support.fileInput ? undefined : 'disabled');
});

